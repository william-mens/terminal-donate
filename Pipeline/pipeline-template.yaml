AWSTemplateFormatVersion: 2010-09-09
Description: >
    Pipeline for the rpay ussd API
Resources:
    ######   #######  ##     ## ########   ######  ########
    ##    ## ##     ## ##     ## ##     ## ##    ## ##
    ##       ##     ## ##     ## ##     ## ##       ##
    ######  ##     ## ##     ## ########  ##       ######
    ## ##     ## ##     ## ##   ##   ##       ##
    ##    ## ##     ## ##     ## ##    ##  ##    ## ##
    ######   #######   #######  ##     ##  ######  ########

    # CodeBuild project and resources (S3 Bucket for build artifacts, Role, Project)
    BuildArtifactsBucket:
        Type: AWS::S3::Bucket
        Properties:
            BucketEncryption:
                ServerSideEncryptionConfiguration:
                    - ServerSideEncryptionByDefault:
                          SSEAlgorithm: AES256
            Tags:
                - Key: "Stack"
                  Value: !Ref AWS::StackName
                - Key: "Project"
                  Value: rpay-ussd

        DeletionPolicy: Retain
        UpdateReplacePolicy: Retain

    ########  ##     ## #### ##       ########
    ##     ## ##     ##  ##  ##       ##     ##
    ##     ## ##     ##  ##  ##       ##     ##
    ########  ##     ##  ##  ##       ##     ##
    ##     ## ##     ##  ##  ##       ##     ##
    ##     ## ##     ##  ##  ##       ##     ##
    ########   #######  #### ######## ########

    CodeBuildProject:
        Type: AWS::CodeBuild::Project
        Properties:
            Name: rpay-ussd
            Description: Build project for the rpay-ussd
            Artifacts:
                Type: CODEPIPELINE
            Environment:
                Type: LINUX_CONTAINER
                ComputeType: BUILD_GENERAL1_SMALL
                Image: aws/codebuild/amazonlinux2-x86_64-standard:2.0 # More info on Images: https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-available.html
                EnvironmentVariables:
                    - Name: BUILD_OUTPUT_BUCKET
                      Value: !Ref BuildArtifactsBucket
            Cache:
                Type: S3
                Location: !Sub ${BuildArtifactsBucket}/codebuild-cache
            ServiceRole: !GetAtt CodeBuildServiceRole.Arn
            Source:
                Type: CODEPIPELINE
            Tags:
                - Key: "Stack"
                  Value: !Ref AWS::StackName
                - Key: "Project"
                  Value: rpay-ussd

    ########  #### ########  ######## ##       #### ##    ## ########
    ##     ##  ##  ##     ## ##       ##        ##  ###   ## ##
    ##     ##  ##  ##     ## ##       ##        ##  ####  ## ##
    ########   ##  ########  ######   ##        ##  ## ## ## ######
    ##         ##  ##        ##       ##        ##  ##  #### ##
    ##         ##  ##        ##       ##        ##  ##   ### ##
    ##        #### ##        ######## ######## #### ##    ## ########

    Pipeline:
        Type: AWS::CodePipeline::Pipeline
        Properties:
            ArtifactStore:
                Location: !Ref BuildArtifactsBucket
                Type: S3
            Name: rpay-ussd
            RoleArn: !GetAtt CodePipelineExecutionRole.Arn
            Stages:
                - Name: Source
                  Actions:
                      - Name: SourceCodeRepo
                        ActionTypeId:
                            # More info on Possible Values: https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#action-requirements
                            Category: Source
                            Owner: AWS
                            Provider: CodeCommit
                            Version: "1"
                        Configuration:
                            RepositoryName: rpay-ussd
                            BranchName: master
                        OutputArtifacts:
                            - Name: SourceCodeAsZip
                        RunOrder: 1
                - Name: Build
                  Actions:
                      - Name: CodeBuild
                        ActionTypeId:
                            Category: Build
                            Owner: AWS
                            Provider: CodeBuild
                            Version: "1"
                        Configuration:
                            ProjectName: !Ref CodeBuildProject
                        InputArtifacts:
                            - Name: SourceCodeAsZip
                        OutputArtifacts:
                            - Name: BuildArtifactAsZip
                - Name: DEV
                  Actions:
                      - Name: CreateChangeSet
                        ActionTypeId:
                            Category: Deploy
                            Owner: AWS
                            Provider: CloudFormation
                            Version: "1"
                        Configuration:
                            # More info on Possible Values for Cloudformation: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/continuous-delivery-codepipeline-action-reference.html#w2ab2c13c13b9
                            ActionMode: CHANGE_SET_REPLACE
                            RoleArn: !GetAtt CloudFormationExecutionRole.Arn
                            StackName: rpay-ussd-dev
                            ChangeSetName: rpay-ussd-ChangeSet-DEV
                            TemplatePath: BuildArtifactAsZip::packaged.yaml
                            Capabilities: CAPABILITY_IAM
                        InputArtifacts:
                            - Name: BuildArtifactAsZip
                        RunOrder: 1
                      - Name: ExecuteChangeSet
                        ActionTypeId:
                            Category: Deploy
                            Owner: AWS
                            Provider: CloudFormation
                            Version: "1"
                        Configuration:
                            ActionMode: CHANGE_SET_EXECUTE
                            RoleArn: !GetAtt CloudFormationExecutionRole.Arn
                            StackName: rpay-ussd-dev
                            ChangeSetName: rpay-ussd-ChangeSet-DEV
                        OutputArtifacts:
                            - Name: rpay-ussdDEVChangeSet
                        RunOrder: 2
                - Name: Prod
                  Actions:
                      - Name: Build
                        ActionTypeId:
                            Category: Build
                            Owner: AWS
                            Provider: CodeBuild
                            Version: "1"
                        Configuration:
                            ProjectName: live-js-serverless
                        InputArtifacts:
                            - Name: SourceCodeAsZip
                        OutputArtifacts:
                            - Name: BuildProdArtifactAsZip
                        RunOrder: 1
                      - Name: CreateChangeSet
                        ActionTypeId:
                            Category: Deploy
                            Owner: AWS
                            Provider: CloudFormation
                            Version: "1"
                        Configuration:
                            # More info on Possible Values for Cloudformation: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/continuous-delivery-codepipeline-action-reference.html#w2ab2c13c13b9
                            ActionMode: CHANGE_SET_REPLACE
                            RoleArn: !GetAtt CloudFormationExecutionRole.Arn
                            StackName: rpay-ussd-prod
                            ChangeSetName: rpay-ussd-ChangeSet-PROD
                            TemplatePath: BuildProdArtifactAsZip::live-packaged.yaml
                            Capabilities: CAPABILITY_IAM
                        InputArtifacts:
                            - Name: BuildProdArtifactAsZip
                        RunOrder: 2
                      - Name: ExecuteChangeSet
                        ActionTypeId:
                            Category: Deploy
                            Owner: AWS
                            Provider: CloudFormation
                            Version: "1"
                        Configuration:
                            ActionMode: CHANGE_SET_EXECUTE
                            RoleArn: !GetAtt CloudFormationExecutionRole.Arn
                            StackName: rpay-ussd-prod
                            ChangeSetName: rpay-ussd-ChangeSet-PROD
                        OutputArtifacts:
                            - Name: rpay-ussdPRODChangeSet
                        RunOrder: 3

    ####    ###    ##     ##
    ##    ## ##   ###   ###
    ##   ##   ##  #### ####
    ##  ##     ## ## ### ##
    ##  ######### ##     ##
    ##  ##     ## ##     ##
    #### ##     ## ##     ##

    CodeBuildServiceRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Action:
                          - "sts:AssumeRole"
                      Effect: Allow
                      Principal:
                          Service:
                              - codebuild.amazonaws.com
            Path: /
            Policies:
                - PolicyName: CodeBuildLogs
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - "logs:CreateLogGroup"
                                - "logs:CreateLogStream"
                                - "logs:PutLogEvents"
                            Resource:
                                - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/rpay-ussd"
                                - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/rpay-ussd:*"
                - PolicyName: CodeBuildArtifactsBucket
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - "s3:GetObject"
                                - "s3:GetObjectVersion"
                                - "s3:PutObject"
                            Resource:
                                - !Sub "arn:aws:s3:::${BuildArtifactsBucket}/*"
                - PolicyName: CodeBuildParameterStore
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action: "ssm:GetParameters"
                            Resource: "*"

    CloudFormationExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    Action: "sts:AssumeRole"
                    Effect: Allow
                    Principal:
                        Service: cloudformation.amazonaws.com
            Path: /
            ManagedPolicyArns:
                - "arn:aws:iam::aws:policy/AdministratorAccess"

    CodePipelineExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Action:
                          - "sts:AssumeRole"
                      Effect: Allow
                      Principal:
                          Service:
                              - codepipeline.amazonaws.com
            Path: /
            Policies:
                - PolicyName: CodePipelineAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - "iam:PassRole"
                                - "lambda:InvokeFunction"
                                - "lambda:ListFunctions"
                                - "lambda:InvokeAsyc"
                            Resource: "*"
                - PolicyName: CodePipelineCodeAndArtifactsS3Bucket
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action: "s3:*"
                            Resource: !Sub "arn:aws:s3:::${BuildArtifactsBucket}/*"
                          - Effect: Allow
                            Action: "codecommit:*"
                            Resource:
                                - !Sub "arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:rpay-ussd"

                - PolicyName: CodePipelineCodeBuildAndCloudformationAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - "codebuild:StartBuild"
                                - "codebuild:BatchGetBuilds"
                            Resource:
                                - !Sub "arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/${CodeBuildProject}"
                                - "arn:aws:codebuild:eu-west-1:741980715081:project/live-js-serverless"
                          - Effect: Allow
                            Action:
                                - "cloudformation:CreateStack"
                                - "cloudformation:DescribeStacks"
                                - "cloudformation:DeleteStack"
                                - "cloudformation:UpdateStack"
                                - "cloudformation:CreateChangeSet"
                                - "cloudformation:ExecuteChangeSet"
                                - "cloudformation:DeleteChangeSet"
                                - "cloudformation:DescribeChangeSet"
                                - "cloudformation:SetStackPolicy"
                                - "cloudformation:SetStackPolicy"
                                - "cloudformation:ValidateTemplate"
                            Resource:
                                - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/rpay-ussd*/*"
                                - !Sub "arn:aws:cloudformation:${AWS::Region}:aws:transform/Serverless-2016-10-31"

Outputs:
    BuildArtifactS3Bucket:
        Description: Amazon S3 Bucket for Pipeline and Build artifacts
        Value: !Ref BuildArtifactsBucket

    CodeBuildProject:
        Description: CodeBuild Project name
        Value: !Ref CodeBuildProject

    CodePipeline:
        Description: AWS CodePipeline pipeline name
        Value: !Ref Pipeline

    CodeBuildIAMRole:
        Description: CodeBuild IAM Role
        Value: !GetAtt CodeBuildServiceRole.Arn

    CloudformationIAMRole:
        Description: Cloudformation IAM Role
        Value: !GetAtt CloudFormationExecutionRole.Arn

    CodePipelineIAMRole:
        Description: CodePipeline IAM Role
        Value: !GetAtt CodePipelineExecutionRole.Arn
